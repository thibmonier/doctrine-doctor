<?php

/*
 * This file is part of the Doctrine Doctor.
 * (c) 2025 Ahmed EBEN HASSINE
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */

declare(strict_types=1);

namespace AhmedBhs\DoctrineDoctor\DependencyInjection;

use Symfony\Component\Config\Definition\Builder\TreeBuilder;
use Symfony\Component\Config\Definition\ConfigurationInterface;

class Configuration implements ConfigurationInterface
{
    public function getConfigTreeBuilder(): TreeBuilder
    {
        $treeBuilder    = new TreeBuilder('doctrine_doctor');
        $nodeDefinition = $treeBuilder->getRootNode();

        $nodeDefinition
            ->children()
                ->booleanNode('enabled')
                    ->defaultTrue()
                    ->info('Enable or disable Doctrine Doctor')
                ->end()
                ->arrayNode('analysis')
                    ->addDefaultsIfNotSet()
                    ->children()
                        ->booleanNode('exclude_third_party_entities')
                            ->defaultTrue()
                            ->info('Exclude entities from vendor/ directory during analysis (recommended for cleaner reports)')
                        ->end()
                    ->end()
                ->end()
                ->arrayNode('analyzers')
                    ->addDefaultsIfNotSet()
                    ->children()
                        ->arrayNode('n_plus_one')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')->defaultTrue()->end()
                                ->integerNode('threshold')
                                    ->defaultValue(5)
                                    ->min(1)
                                    ->info('Minimum number of similar queries to trigger N+1 detection')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('slow_query')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')->defaultTrue()->end()
                                ->integerNode('threshold')
                                    ->defaultValue(100)
                                    ->min(1)
                                    ->info('Threshold in milliseconds for slow query detection')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('missing_index')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')->defaultTrue()->end()
                                ->integerNode('slow_query_threshold')
                                    ->defaultValue(50)
                                    ->min(1)
                                    ->info('Only run EXPLAIN on queries slower than this (ms)')
                                ->end()
                                ->booleanNode('explain_queries')
                                    ->defaultTrue()
                                    ->info('Execute EXPLAIN to detect missing indexes')
                                ->end()
                                ->integerNode('min_rows_scanned')
                                    ->defaultValue(1000)
                                    ->min(1)
                                    ->info('Minimum rows scanned to suggest an index')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('hydration')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')->defaultTrue()->end()
                                ->integerNode('row_threshold')
                                    ->defaultValue(99)
                                    ->min(1)
                                    ->info('Number of rows to consider for hydration analysis')
                                ->end()
                                ->integerNode('critical_threshold')
                                    ->defaultValue(999)
                                    ->min(1)
                                    ->info('Number of rows to mark as critical')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('eager_loading')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')->defaultTrue()->end()
                                ->integerNode('join_threshold')
                                    ->defaultValue(4)
                                    ->min(1)
                                    ->info('Maximum number of JOINs before warning')
                                ->end()
                                ->integerNode('critical_join_threshold')
                                    ->defaultValue(7)
                                    ->min(1)
                                    ->info('Number of JOINs to mark as critical')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('find_all')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Enable findAll() detection')
                                ->end()
                                ->integerNode('threshold')
                                    ->defaultValue(99)
                                    ->info('Maximum number of rows before flagging as issue')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('entity_manager_clear')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Enable EntityManager::clear() detection for batch operations')
                                ->end()
                                ->integerNode('batch_size_threshold')
                                    ->defaultValue(20)
                                    ->min(1)
                                    ->info('Minimum number of INSERT/UPDATE operations to trigger detection')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('get_reference')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Enable getReference() optimization detection')
                                ->end()
                                ->integerNode('threshold')
                                    ->defaultValue(2)
                                    ->min(1)
                                    ->info('Minimum number of simple SELECT by ID queries to suggest getReference()')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('flush_in_loop')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Enable flush() in loop detection (anti-pattern)')
                                ->end()
                                ->integerNode('flush_count_threshold')
                                    ->defaultValue(5)
                                    ->min(1)
                                    ->info('Minimum number of flush calls to trigger detection')
                                ->end()
                                ->integerNode('time_window_ms')
                                    ->defaultValue(1000)
                                    ->min(1)
                                    ->info('Time window in milliseconds to consider flushes as being in a loop')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('lazy_loading')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Enable lazy loading in loop detection')
                                ->end()
                                ->integerNode('threshold')
                                    ->defaultValue(10)
                                    ->min(1)
                                    ->info('Minimum number of lazy load queries to trigger detection')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('dql_injection')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Enable DQL/SQL injection vulnerability detection (security)')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('bulk_operation')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Enable bulk operation optimization detection')
                                ->end()
                                ->integerNode('threshold')
                                    ->defaultValue(20)
                                    ->min(1)
                                    ->info('Minimum number of UPDATE/DELETE to suggest bulk operations')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('strict_mode')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Check MySQL/MariaDB SQL strict moconfiguration')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('charset')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Check database charset (utf8 vs utf8mb4)')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('innodb_engine')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Check if tables use InnoDB engine')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('connection_pooling')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Analyze connection pool configuration')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('collection_initialization')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Detect uninitialized entity collections')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('cascade_configuration')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Analyze cascaconfiguration on associations')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('sensitive_data_exposure')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Detect sensitive data exposure in serialization')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('insecure_random')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Detect insecure random generators for security operations')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('sql_injection_raw_queries')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Detect SQL injection vulnerabilities in raw queries')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('foreign_key_mapping')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Detect foreign keys mapped as primitives instead of object relations')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('partial_object')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Detect queries loading full entities when partial objects would be more efficient')
                                ->end()
                                ->integerNode('threshold')
                                    ->defaultValue(5)
                                    ->min(1)
                                    ->info('Minimum number of queries to trigger detection')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('dto_hydration')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Detect aggregation queries that should use DTO hydration')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('cascade_all')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Detect dangerous cascade="all" usage')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('cascade_persist_independent')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Detect cascade="persist" on independent entities (risk of duplicates)')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('missing_orphan_removal')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Detect composition relationships without orphanRemoval')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('cascade_remove_independent')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Detect cascade="remove" on independent entities (data loss risk)')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('bidirectional_consistency')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Detect inconsistencies in bidirectional associations')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('orphan_removal_no_cascade')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Detect orphanRemoval without cascade="remove"')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('ondelete_mismatch')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Detect mismatches between ORM cascade and database onDelete')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('join_optimization')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Detect suboptimal JOIN usage (LEFT JOIN on NOT NULL, too many JOINs, unused JOINs)')
                                ->end()
                                ->integerNode('max_joins_recommended')
                                    ->defaultValue(5)
                                    ->min(1)
                                    ->info('Maximum recommended number of JOINs in a single query')
                                ->end()
                                ->integerNode('max_joins_critical')
                                    ->defaultValue(8)
                                    ->min(1)
                                    ->info('Number of JOINs to mark as critical')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('doctrine_cache')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Detect ArrayCache in production (causes 50-80% performance loss)')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('naming_convention')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Detect naming convention violations (tables/columns should be snake_case)')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('missing_embeddable_opportunity')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Detect groups of properties that should be refactored into Embeddables (Address, Money, PersonName, etc.)')
                                ->end()
                            ->end()
                        ->end()
                        ->arrayNode('blameable_trait')
                            ->addDefaultsIfNotSet()
                            ->children()
                                ->booleanNode('enabled')
                                    ->defaultTrue()
                                    ->info('Detect missing blameable/timestampable traits and bad practices in existing implementations')
                                ->end()
                            ->end()
                        ->end()
                    ->end()
                ->end()
                ->arrayNode('profiler')
                    ->addDefaultsIfNotSet()
                    ->children()
                        ->booleanNode('show_in_toolbar')
                            ->defaultTrue()
                            ->info('Show Doctrine Doctor in the Symfony profiler toolbar')
                        ->end()
                        ->booleanNode('show_debug_info')
                            ->defaultFalse()
                            ->info('Show debug information (for bundle maintainers and debugging purposes)')
                        ->end()
                    ->end()
                ->end()
                ->arrayNode('debug')
                    ->addDefaultsIfNotSet()
                    ->info('Debug settings for contributors and advanced users')
                    ->children()
                        ->booleanNode('enabled')
                            ->defaultFalse()
                            ->info('Enable debug mode (verbose logging, detailed error messages). Keep disabled for production.')
                        ->end()
                        ->booleanNode('internal_logging')
                            ->defaultFalse()
                            ->info('Enable internal logging for Doctrine Doctor analyzers. Can add ~133ms overhead. Enable only for debugging.')
                        ->end()
                    ->end()
                ->end()
            ->end();

        return $treeBuilder;
    }
}
